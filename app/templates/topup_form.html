{% extends 'dashboard.html' %}
{% block content %}
<div class="p-6 max-w-xl mx-auto">
  <h1 class="text-2xl font-semibold mb-6">Topup Saldo</h1>

  <div class="bg-white shadow rounded p-6">
    <p class="mb-4 text-gray-700">
      <strong>Pelanggan:</strong> {{ pelanggan.nama_pelanggan }}<br>
      <strong>UID:</strong> {{ pelanggan.uid_rfid }}<br>
      <strong>Biaya Admin:</strong> Rp {{ "{:,.2f}".format(biaya_topup or 0) }}
    </p>

    <form method="POST" id="topupForm">
      <label class="block mb-4">
        <span class="text-gray-700">Nominal Topup</span>
        <input type="number" step="0.01" name="nominal" id="nominal"
               class="mt-1 block w-full px-3 py-2 border rounded" />
      </label>

      <div class="mb-4 p-3 bg-gray-100 rounded text-sm">
        <p>Biaya admin: <strong id="txt_biaya">Rp {{ "{:,.2f}".format(biaya_topup or 0) }}</strong></p>
        <p>Saldo diterima: <strong id="txt_saldo_masuk">Rp 0</strong></p>
        <p id="err_msg" class="text-red-600 mt-2 hidden"></p>
      </div>

      <div class="flex justify-end">
        <a href="{{ url_for('tapping.show_tapping', uid=pelanggan.uid_rfid) }}"
           class="px-4 py-2 bg-gray-300 rounded mr-2">Batal</a>

        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
          Proses Topup
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Wrap logic in a named function and invoke it to avoid IIFE parsing issues.
  function initTopup() {
    // Ambil biaya admin sebagai angka JS. tojson memastikan format literal JS
    const biayaAdmin = {{ biaya_topup|tojson|default(0) }};

    const nominalEl = document.getElementById('nominal');
    const txtBiaya = document.getElementById('txt_biaya');
    const txtSaldoMasuk = document.getElementById('txt_saldo_masuk');
    const errMsg = document.getElementById('err_msg');
    const form = document.getElementById('topupForm');

    // Inisialisasi tampilan biaya
    txtBiaya.innerText = "Rp " + Number(biayaAdmin).toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    txtSaldoMasuk.innerText = "Rp 0,00";

    if (!nominalEl) return;

    function updatePreview() {
      const nominal = parseFloat(nominalEl.value) || 0;
      const masuk = nominal - Number(biayaAdmin);

      // format rupiah
      txtSaldoMasuk.innerText = "Rp " + (masuk >= 0 ? masuk : 0).toLocaleString('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});

      // show validation
      if (masuk < 0) {
        errMsg.innerText = "Nominal topup harus lebih besar atau sama dengan biaya admin (Rp " + Number(biayaAdmin).toLocaleString('id-ID', {minimumFractionDigits:2}) + ").";
        errMsg.classList.remove('hidden');
      } else {
        errMsg.innerText = "";
        errMsg.classList.add('hidden');
      }
    }

    nominalEl.addEventListener('input', updatePreview);

    // Validasi akhir sebelum submit (tambahan security di sisi klien)
    form.addEventListener('submit', function(e) {
      const nominal = parseFloat(nominalEl.value) || 0;
      const masuk = nominal - Number(biayaAdmin);
      if (nominal <= 0) {
        e.preventDefault();
        errMsg.innerText = "Nominal topup harus lebih besar dari 0.";
        errMsg.classList.remove('hidden');
        return;
      }
      if (masuk < 0) {
        e.preventDefault();
        errMsg.innerText = "Nominal tidak mencukupi biaya admin.";
        errMsg.classList.remove('hidden');
        return;
      }
    });
  }

  // invoke
  initTopup();
</script>
{% endblock %}
